# Исправления загрузки данных из Tinkoff API

## Проблема
Код получал ошибку 500 при попытке загрузить данные через Tinkoff Invest API, хотя в браузере ссылка работала корректно.

## Решение

### 1. Исправлен параметр запроса API (src/data/loaders/tinkoff.py)
**Было:**
```python
params = {
    'instrument_id': instrument.instrument_id,
    'year': year,
}
```

**Стало:**
```python
params = {
    'figi': instrument.figi,  # API ожидает параметр 'figi', а не 'instrument_id'
    'year': year,
}
```

### 2. Улучшен резолвинг инструментов
Добавлена логика предпочтения инструментов MOEX (class_code начинается с "TQ"):
```python
# Предпочитаем инструменты MOEX (class_code начинается с TQ)
candidates = [
    ins for ins in response.instruments
    if ins.ticker.upper() == ticker.upper() and ins.class_code.upper().startswith("TQ")
]

if not candidates:
    # Fallback: любые совпадения по тикеру
    candidates = [ins for ins in response.instruments if ins.ticker.upper() == ticker.upper()]
```

### 3. Улучшен парсинг CSV файлов
Данные теперь читаются сначала как строки, затем преобразуются в нужные типы (более надежный подход из рабочего кода):
```python
df = pd.read_csv(
    buffer,
    sep=';',
    header=None,
    names=list(range(8)),
    usecols=list(range(7)),  # берём первые 7 полей
    dtype=str,  # сначала все как строки
    engine='python',
)
```

### 4. Исправлены deprecated обозначения таймфреймов
В файлах `src/data/preprocessors/resampler.py` и `src/data/validators/integrity.py`:
- '1H' → '1h'
- '4H' → '4h'

## Результат
✅ Данные успешно загружаются для всех тикеров
✅ Нет ошибок 500
✅ Нет предупреждений о deprecated таймфреймах
✅ Все таймфреймы (1m, 5m, 15m, 1h, 4h, 1d) генерируются корректно

## Тестирование
```bash
python -m src.interfaces.cli load-data --ticker ABRD
```

Результат: данные успешно загружены и ресемплированы на все поддерживаемые таймфреймы.
