# Постфильтры разметки

## Назначение
Постфильтрация применяется после первичной разметки таргетов, чтобы улучшить качество сигналов, убрать шум, согласовать итоговые метки с бизнес-правилами и исключить опасные участки данных. Все шаги должны быть воспроизводимыми и логироваться вместе с конфигурацией разметки.

## 1. Фильтры по индикаторам и сигналам
- **Отсечение по индикатору**: обнуление участков `1` (long) при достижении порогов (например, `RSI > 80`, `ADX < 20`).
- **Отсекающие условия для `-1`**: исключение short-сигналов при bullish-индикаторах или низкой волатильности.
- **Фильтрация `0`**: принудительный переход в `flat`, если волатильность слишком низкая/высокая или ликвидность недостаточна.
- **Таймаут подтверждения**: перевод метки в `0`, если подтверждающий сигнал не появился в течение `N` баров.

**Параметры**
- `indicator`: имя индикатора/модели.
- `operator`: `>`, `<`, `between`, `cross`.
- `threshold`: значение или диапазон.
- `timeout_bars`: количество баров ожидания.
- `action`: `drop`, `set_to_zero`, `change_class`.

## 2. Минимальная длина последовательностей
- **Short sequence removal**: удаление последовательностей `1`, `-1`, `0`, длина которых меньше минимального порога.
- **Sequence padding**: расширение слишком коротких последовательностей до минимальной длины (опционально).
- **Symmetric rules**: разные пороги для long/short/flat сигналов.

**Параметры**
- `min_len`: минимальная длина в барах.
- `apply_to`: список классов (`[1, -1, 0]`).
- `strategy`: `drop`, `merge`, `pad`.

## 3. Объединение и сглаживание
- **Merge adjacent sequences**: объединение участков одного класса, если разрыв между ними меньше заданного `gap`.
- **Mode filter**: majority vote в скользящем окне, чтобы сгладить шумные переключения.
- **RLE/компрессия**: хранение результатов в виде run-length encoding и последующая разметка на основе этого представления.

**Параметры**
- `gap`: максимальный разрыв между участками.
- `window`: размер окна для mode filter.
- `min_stay`: минимальное время удержания класса после сглаживания.

## 4. Фильтрация опасных зон и событий
- **Event calendar**: исключение баров до/после новостей, earnings, roll-over.
- **Low liquidity / технические сбои**: удаление участков, помеченных в data filters.
- **Custom zones**: ручное указание временных диапазонов для исключения.
- **Tail cut**: отсечение хвоста последовательности, если внутри неё произошёл запрещённый event.

**Параметры**
- `event_source`: путь к календарю/списку событий.
- `pre_event_bars`, `post_event_bars`.
- `liquidity_threshold`.
- `zones`: список временных интервалов.

## 5. Логирование и метаданные
- Запись изменений (`before` → `after`) для каждого фильтра.
- Хранение `filter_id`, версии параметров и ссылок на конфигурацию таргета.
- Подсчёт статистики: сколько баров/сигналов было изменено каждым фильтром.
- Сохранение результатов в MLflow/metadata (для воспроизводимости).

## Рекомендации по реализации
1. Постфильтры оформлять как последовательность шагов (pipeline) с конфигурацией в YAML/JSON.
2. Указывать порядок применения (некоторые фильтры зависят от результатов предыдущих).
3. Применять тесты/валидацию, чтобы проверить, что фильтры не нарушают каузальность.
4. Вести журнал изменений и хранить конфигурацию в репозитории вместе с таргетами.
5. При появлении новых фильтров добавлять их описание и версионировать схемы (Pydantic, JSON Schema).
