# Этап 00: Инициализация проекта и настройка окружения

## Цель этапа
Создать базовую структуру проекта, настроить инструменты разработки, систему контроля версий и окружение для воспроизводимой разработки.

## Зависимости
Нет (это первый этап)

## Описание задач

### 1. Структура проекта

Создать следующую структуру директорий:

```
trading-platform/
├── src/                          # Исходный код
│   ├── data/                     # Модуль данных
│   ├── features/                 # Генерация признаков
│   ├── labeling/                 # Разметка таргетов
│   ├── modeling/                 # Модели и обучение
│   ├── evaluation/               # Оценка моделей
│   ├── backtesting/              # Бэктестинг
│   ├── pipelines/                # Пайплайны
│   ├── orchestration/            # Оркестрация
│   ├── interfaces/               # CLI и GUI
│   │   ├── cli/
│   │   └── gui/
│   └── common/                   # Общие утилиты
│       ├── config.py
│       ├── logging.py
│       ├── validation.py
│       ├── interfaces.py
│       └── container.py
├── configs/                      # Конфигурационные файлы
│   ├── data/
│   ├── features/
│   ├── models/
│   ├── backtests/
│   └── environments/
├── artifacts/                    # Артефакты (не в git)
│   ├── data/
│   ├── models/
│   ├── features/
│   ├── backtests/
│   ├── logs/
│   └── manifests/
├── tests/                        # Тесты
│   ├── unit/
│   ├── integration/
│   ├── e2e/
│   ├── benchmarks/
│   └── conftest.py
├── scripts/                      # Вспомогательные скрипты
├── infra/                        # Инфраструктура
│   ├── docker/
│   └── github-actions/
├── docs/                         # Документация (уже есть)
├── .github/
│   └── workflows/
├── .gitignore
├── .pre-commit-config.yaml
├── pyproject.toml
├── requirements.txt
├── requirements-dev.txt
├── docker-compose.cpu.yml
├── docker-compose.gpu.yml
├── Dockerfile
└── README.md
```

### 2. Git репозиторий

**Инициализация:**
- Создать Git репозиторий
- Настроить `.gitignore` для Python проектов
- Исключить из версионирования: `artifacts/`, `.env`, `*.pyc`, `__pycache__/`, `.mypy_cache/`, `.pytest_cache/`
- Создать начальный коммит

**Настройка веток:**
- Основная ветка: `main`
- Защитить ветку `main` от прямых push
- Настроить правила: требовать pull request и прохождение CI

**`.gitignore`:**
```
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
env/
venv/
.venv/
*.egg-info/
dist/
build/

# IDEs
.vscode/
.idea/
*.swp
*.swo

# Artifacts
artifacts/
*.log
*.pkl
*.pth
*.pt
*.onnx
*.parquet
*.csv
*.db

# Environment
.env
.env.local

# Jupyter
.ipynb_checkpoints/

# Testing
.pytest_cache/
.coverage
htmlcov/
.mypy_cache/
.hypothesis/

# OS
.DS_Store
Thumbs.db
```

### 3. Управление зависимостями

**requirements.txt (основные зависимости):**
```
# Core
python>=3.10
numpy>=1.24.0
pandas>=2.0.0
pyarrow>=11.0.0  # для Parquet

# ML frameworks
scikit-learn>=1.3.0
lightgbm>=4.0.0
xgboost>=2.0.0
catboost>=1.2.0

# Deep Learning
torch>=2.0.0
pytorch-lightning>=2.0.0

# Technical analysis
ta-lib>=0.4.26  # потребует отдельной установки C библиотеки
pandas-ta>=0.3.14

# Data validation
pydantic>=2.0.0
jsonschema>=4.17.0

# Configuration
pyyaml>=6.0
python-dotenv>=1.0.0
omegaconf>=2.3.0

# Experiment tracking
mlflow>=2.7.0

# API
tinkoff-investments>=0.2.0b0
requests>=2.31.0
aiohttp>=3.8.0

# Logging
loguru>=0.7.0

# Utils
tqdm>=4.65.0
click>=8.1.0
```

**requirements-dev.txt (для разработки):**
```
# Testing
pytest>=7.4.0
pytest-cov>=4.1.0
pytest-benchmark>=4.0.0
pytest-mock>=3.11.0
pytest-asyncio>=0.21.0
hypothesis>=6.82.0

# Linting and formatting
black>=23.7.0
isort>=5.12.0
flake8>=6.1.0
mypy>=1.5.0
pylint>=2.17.0
bandit>=1.7.5

# Pre-commit
pre-commit>=3.3.0

# Profiling
memory-profiler>=0.61.0
line-profiler>=4.0.0
py-spy>=0.3.14

# Documentation
sphinx>=7.0.0
sphinx-rtd-theme>=1.3.0

# Jupyter
jupyter>=1.0.0
ipykernel>=6.25.0
```

**pyproject.toml (конфигурация инструментов):**
```toml
[build-system]
requires = ["setuptools>=68.0", "wheel"]
build-backend = "setuptools.build_meta"

[project]
name = "trading-platform"
version = "0.1.0"
description = "Модульная платформа для разработки и тестирования торговых моделей"
requires-python = ">=3.10"
authors = [
    {name = "Your Name", email = "your.email@example.com"}
]

[tool.black]
line-length = 88
target-version = ['py310']
include = '\.pyi?$'
extend-exclude = '''
/(
  \.git
  | \.mypy_cache
  | \.pytest_cache
  | \.venv
  | build
  | dist
)/
'''

[tool.isort]
profile = "black"
line_length = 88
multi_line_output = 3
include_trailing_comma = true
force_grid_wrap = 0
use_parentheses = true
ensure_newline_before_comments = true

[tool.mypy]
python_version = "3.10"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true
no_implicit_optional = true
warn_redundant_casts = true
warn_unused_ignores = true
warn_no_return = true
check_untyped_defs = true
strict_equality = true

[[tool.mypy.overrides]]
module = [
    "sklearn.*",
    "lightgbm.*",
    "xgboost.*",
    "catboost.*",
    "talib.*",
]
ignore_missing_imports = true

[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = ["test_*.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
addopts = [
    "-v",
    "--strict-markers",
    "--tb=short",
    "--cov=src",
    "--cov-report=html",
    "--cov-report=term-missing",
]
markers = [
    "slow: marks tests as slow (deselect with '-m \"not slow\"')",
    "gpu: marks tests that require GPU",
    "integration: marks integration tests",
    "e2e: marks end-to-end tests",
]

[tool.coverage.run]
source = ["src"]
omit = [
    "*/tests/*",
    "*/__init__.py",
]

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "raise AssertionError",
    "raise NotImplementedError",
    "if __name__ == .__main__.:",
    "if TYPE_CHECKING:",
]
```

### 4. Pre-commit hooks

**Создать `.pre-commit-config.yaml`:**
```yaml
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.4.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-added-large-files
        args: ['--maxkb=1000']
      - id: check-json
      - id: check-merge-conflict
      - id: debug-statements

  - repo: https://github.com/psf/black
    rev: 23.7.0
    hooks:
      - id: black
        language_version: python3.10

  - repo: https://github.com/PyCQA/isort
    rev: 5.12.0
    hooks:
      - id: isort
        args: ['--profile=black']

  - repo: https://github.com/PyCQA/flake8
    rev: 6.1.0
    hooks:
      - id: flake8
        args: ['--max-line-length=88', '--extend-ignore=E203,W503']

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.5.0
    hooks:
      - id: mypy
        additional_dependencies: [types-all]
        args: ['--ignore-missing-imports']
```

**Установка:**
```bash
pre-commit install
```

### 5. Docker контейнеризация

**Dockerfile:**
Создать multi-stage Dockerfile с поддержкой CPU и GPU режимов.

**docker-compose.cpu.yml:**
Конфигурация для работы на CPU (ноутбук).

**docker-compose.gpu.yml:**
Конфигурация для работы на GPU (стационарный ПК).

### 6. Environment variables

**Создать шаблон `.env.example`:**
```env
# Tinkoff API
TINKOFF_API_TOKEN=your_token_here
TINKOFF_API_SANDBOX=true

# Database (если используется)
DATABASE_URL=sqlite:///artifacts/db/platform.db

# MLflow
MLFLOW_TRACKING_URI=file:///artifacts/mlruns
MLFLOW_EXPERIMENT_NAME=default

# Paths
DATA_DIR=artifacts/data
MODELS_DIR=artifacts/models
LOGS_DIR=artifacts/logs

# Performance
N_JOBS=-1
GPU_ENABLED=true
GPU_DEVICE_ID=0

# Logging
LOG_LEVEL=INFO
LOG_FORMAT=json
```

### 7. Базовые утилиты

**src/common/config.py:**
- Загрузка конфигураций из YAML
- Загрузка переменных окружения
- Валидация конфигураций с помощью Pydantic
- Merge конфигураций (defaults + user config)

**src/common/logging.py:**
- Настройка structured logging (JSON формат)
- Ротация логов
- Разные уровни логирования для разных модулей
- Интеграция с MLflow

**src/common/validation.py:**
- Базовые Pydantic схемы
- Общие валидаторы данных
- Проверка look-ahead

**src/common/interfaces.py:**
- Protocol интерфейсы для основных компонентов
- DTOs для передачи данных между модулями

### 8. Начальная документация

**README.md:**
- Описание проекта
- Quick start guide
- Требования к системе
- Инструкции по установке
- Базовые примеры использования
- Ссылки на документацию

**CONTRIBUTING.md:**
- Как вносить изменения
- Code style guidelines
- Процесс pull request
- Тестирование

**CHANGELOG.md:**
- Структура для ведения changelog

## Критерии проверки готовности

### Обязательные:
- [ ] Создана полная структура директорий
- [ ] Git репозиторий инициализирован и сделан первый коммит
- [ ] `.gitignore` настроен и протестирован
- [ ] Все зависимости установлены без ошибок
- [ ] Pre-commit hooks настроены и работают
- [ ] `pyproject.toml` корректно настроен
- [ ] Docker файлы созданы и образ собирается
- [ ] `.env.example` создан
- [ ] Базовые утилиты (`config.py`, `logging.py`) реализованы
- [ ] README.md содержит всю необходимую информацию
- [ ] Можно импортировать модули из `src/` без ошибок

### Тесты:
- [ ] Тест импорта всех базовых модулей
- [ ] Тест загрузки конфигурации
- [ ] Тест настройки логирования
- [ ] Flake8, mypy, black проходят без ошибок

### Документация:
- [ ] README.md актуален
- [ ] CONTRIBUTING.md создан
- [ ] Структура проекта задокументирована

## Промпты для реализации

### Промпт 1: Создание структуры проекта
```
Создай базовую структуру проекта для торговой платформы согласно следующей спецификации:

[вставить структуру из раздела "Структура проекта"]

Создай все необходимые директории и пустые __init__.py файлы для Python пакетов.
Также создай файлы .gitignore, requirements.txt, requirements-dev.txt, pyproject.toml согласно спецификации в файле "план/Этап_00_Инициализация_проекта.md".
```

### Промпт 2: Настройка инструментов разработки
```
Настрой инструменты разработки для Python проекта:

1. Создай .pre-commit-config.yaml с настройками black, isort, flake8, mypy
2. Создай pyproject.toml с конфигурациями для всех инструментов
3. Убедись что все конфигурации совместимы друг с другом (особенно black и isort)

Требования:
- Line length: 88
- Python version: 3.10+
- Строгая типизация с mypy
- Используй спецификацию из файла "план/Этап_00_Инициализация_проекта.md"
```

### Промпт 3: Базовые утилиты
```
Реализуй базовые утилиты в src/common/:

1. config.py - Система управления конфигурациями:
   - Загрузка YAML конфигов
   - Загрузка .env переменных
   - Валидация с Pydantic
   - Merge конфигураций (defaults + custom)
   - Поддержка вложенных конфигураций

2. logging.py - Система логирования:
   - Structured logging (JSON формат)
   - Разные уровни для разных модулей
   - Ротация файлов
   - Интеграция с MLflow
   - Context manager для логирования операций

3. validation.py - Базовые валидаторы:
   - Pydantic схемы для OHLCV данных
   - Проверка таймзон
   - Валидация путей к файлам
   - Проверка look-ahead

4. interfaces.py - Protocol интерфейсы:
   - DataLoader protocol
   - Model protocol
   - FeatureCalculator protocol
   - Базовые DTOs

Используй type hints, docstrings (Google style), обработку ошибок.
Следуй стандартам из docs/system/Development_Standards.md.
```

### Промпт 4: Docker контейнеризация
```
Создай Docker конфигурации для проекта:

1. Dockerfile (multi-stage):
   - Stage 1: dependencies (Python 3.10, системные зависимости)
   - Stage 2: production (только необходимое для работы)
   - Поддержка как CPU так и GPU режимов

2. docker-compose.cpu.yml:
   - Конфигурация для работы на CPU
   - Volume mounts для artifacts/
   - Правильные переменные окружения

3. docker-compose.gpu.yml:
   - Конфигурация для работы на GPU
   - NVIDIA runtime
   - GPU device mapping

Требования:
- Образ должен быть оптимизирован по размеру
- Использовать .dockerignore
- Воспроизводимые builds
```

### Промпт 5: Документация
```
Создай начальную документацию проекта:

1. README.md:
   - Описание проекта и его целей
   - Quick start (установка и первый запуск)
   - Требования к системе
   - Структура проекта
   - Примеры использования
   - Ссылки на подробную документацию

2. CONTRIBUTING.md:
   - Как форкнуть и клонировать репозиторий
   - Процесс разработки (ветки, коммиты)
   - Code style и линтеры
   - Как запускать тесты
   - Pull request процесс

3. CHANGELOG.md:
   - Структура для ведения changelog
   - Формат записей (согласно Keep a Changelog)

Используй markdown, добавь badges для CI/CD статуса.
```

### Промпт 6: Начальные тесты
```
Создай начальные тесты для проверки базовой инфраструктуры:

tests/conftest.py:
- Общие fixtures для тестов
- Настройка test environment

tests/unit/common/test_config.py:
- Тест загрузки YAML конфигов
- Тест валидации схем
- Тест merge конфигураций
- Тест обработки ошибок

tests/unit/common/test_logging.py:
- Тест настройки логгера
- Тест structured logging
- Тест context manager

tests/unit/test_imports.py:
- Тест что все основные модули импортируются

Используй pytest, parametrize тесты где возможно.
```

## Важные замечания

### Порядок выполнения:
1. Сначала создать структуру директорий
2. Настроить Git и .gitignore
3. Создать конфигурационные файлы (pyproject.toml, requirements.txt)
4. Установить зависимости в виртуальное окружение
5. Настроить pre-commit hooks
6. Реализовать базовые утилиты
7. Создать Docker конфигурации
8. Написать документацию
9. Создать начальные тесты
10. Сделать коммит и push

### Виртуальное окружение:
- Использовать `venv` или `conda`
- Python 3.10 или выше
- Активировать окружение перед установкой зависимостей

### TA-Lib установка:
TA-Lib требует C библиотеку:
- Windows: скачать wheel файл
- Linux: `sudo apt-get install ta-lib`
- macOS: `brew install ta-lib`

### Тестирование на этом этапе:
```bash
# Форматирование
black src/ tests/
isort src/ tests/

# Линтеры
flake8 src/ tests/
mypy src/

# Тесты
pytest tests/unit/

# Pre-commit
pre-commit run --all-files
```

### Типичные проблемы:
1. **Конфликт black и flake8**: Настроить flake8 с `extend-ignore=E203,W503`
2. **Mypy ошибки для внешних библиотек**: Добавить в `[[tool.mypy.overrides]]`
3. **Pre-commit медленный**: Можно настроить для запуска только на изменённых файлах
4. **Docker образ большой**: Использовать multi-stage build, очистить кэши pip

### Checklist перед переходом к следующему этапу:
- [ ] Все промпты выполнены
- [ ] Все критерии проверки пройдены
- [ ] Тесты запущены и проходят
- [ ] Линтеры не показывают ошибок
- [ ] Документация актуальна
- [ ] Сделан коммит с осмысленным сообщением
- [ ] Pre-commit hooks работают

## Следующий этап
После завершения этого этапа переходите к [Этапу 01: Модуль данных](Этап_01_Модуль_данных.md)
