# Этап 11: Движок бэктестинга

## Цель
Реализовать event-driven backtesting engine с реалистичным учётом комиссий и проскальзывания.

## Зависимости
Этапы 00-10

## Структура

```
src/backtesting/
├── engine.py                     # BacktestEngine
├── strategy.py                   # BaseStrategy
├── exits/                        # Exit rules (docs/exits/)
│   ├── take_profit.py
│   ├── stop_loss.py
│   ├── trailing_stop.py
│   ├── time_stop.py
│   ├── reverse_signal.py
│   └── scale_out.py
├── position.py                   # Position management
├── portfolio.py                  # Portfolio state
├── execution.py                  # Order execution
├── metrics.py                    # Strategy metrics (docs/metrics/strategy/)
└── visualizer.py                 # Equity curves, drawdowns
```

## Ключевые компоненты

### 1. BacktestEngine
```python
class BacktestEngine:
    """Event-driven backtest engine"""

    def run(
        self,
        strategy: BaseStrategy,
        data: pd.DataFrame,
        initial_capital: float = 100000,
        commission: float = 0.001,
        slippage: float = 0.0005
    ) -> BacktestResult:
        """Запустить бэктест"""
```

### 2. BaseStrategy
```python
class BaseStrategy(ABC):
    """Базовая стратегия"""

    @abstractmethod
    def generate_signal(self, bar: dict) -> int:
        """Генерировать сигнал: 1 (buy), -1 (sell), 0 (hold)"""

    @abstractmethod
    def size_position(self, signal: int, portfolio: Portfolio) -> float:
        """Размер позиции"""
```

### 3. Exit Rules (docs/exits/)
- Take Profit (%, ATR-based, volatility-based)
- Stop Loss (%, ATR-based, volatility-based)
- Trailing Stop (price, ATR, indicator)
- Time Stop (max holding period)
- Reverse Signal
- Scale Out (partial closes)
- Risk Limits (max daily loss, portfolio loss)

### 4. Strategy Metrics (docs/metrics/strategy/)
- Sharpe, Sortino, Calmar Ratio
- Max Drawdown, Average Drawdown
- Win Rate, Profit Factor, Payoff Ratio
- Average Trade Return, Average Holding Period
- VaR, CVaR, Tail Ratio
- Turnover, Slippage-adjusted PnL

### 5. Execution Model
```python
class ExecutionModel:
    """Модель исполнения ордеров"""

    def execute_order(
        self,
        order: Order,
        bar: dict,
        slippage: float
    ) -> Execution:
        """
        Учёт:
        - Commission
        - Slippage
        - Partial fills (если нужно)
        """
```

### 6. Prioritization
При совпадении SL и TP на одном баре - приоритет у SL.
При достижении SL - закрытие немедленно.

## Критерии готовности

- [ ] BacktestEngine работает event-driven
- [ ] Все exit rules реализованы
- [ ] Корректный учёт комиссий и slippage
- [ ] Все strategy metrics
- [ ] Position management
- [ ] Визуализация: equity curve, drawdowns, trades
- [ ] CLI: `run-backtest`, `backtest-report`
- [ ] Производительность: 1M баров < 5 минут

## Промпты

```
Реализуй src/backtesting/:
1. engine.py - Event-driven BacktestEngine
2. strategy.py - BaseStrategy и ModelBasedStrategy
3. exits/ - все exit rules из docs/exits/
4. metrics.py - все метрики из docs/metrics/strategy/
5. visualizer.py - графики equity, drawdown, trades

BacktestEngine должен:
- Итерировать по барам
- Генерировать сигналы
- Управлять позициями
- Применять exit rules
- Учитывать комиссии/slippage
- Логировать все сделки

Используй vectorbt для ускорения где возможно.
```

## Следующий этап
[Этап 12: Система пайплайнов](Этап_12_Система_пайплайнов.md)
