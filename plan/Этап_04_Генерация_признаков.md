# Этап 04: Модуль генерации признаков

## Цель
Реализовать систему декларативной генерации признаков с кэшированием и версионированием.

## Зависимости
Этапы 00-03

## Структура

```
src/features/
├── generator.py                  # FeatureGenerator
├── extractors/                   # Извлечение признаков
│   ├── price.py                  # Ценовые признаки
│   ├── volume.py                 # Объёмные
│   ├── calendar.py               # Календарные
│   ├── ticker.py                 # Тикер-специфичные
│   └── higher_tf.py              # Из старших таймфреймов
├── transformers/                 # Трансформации
│   ├── rolling.py                # Rolling статистики
│   ├── lags.py                   # Лаги
│   ├── differences.py            # Разности
│   └── ratios.py                 # Соотношения
├── selectors/                    # Отбор признаков
│   ├── filter_methods.py         # Filter-based
│   ├── wrapper_methods.py        # Wrapper-based
│   ├── embedded_methods.py       # Embedded
│   └── drift_detector.py         # Drift selection
├── cache.py                      # Кэш признаков
└── config_parser.py              # Парсинг YAML конфигов
```

## Основные компоненты

### 1. FeatureGenerator
Оркестрирует генерацию признаков из конфига:
```yaml
features:
  - type: indicator
    name: SMA
    params: {window: 20}
    columns: [close]

  - type: indicator
    name: RSI
    params: {period: 14}

  - type: price
    features: [returns, log_returns, high_low_ratio]

  - type: rolling
    window: 20
    functions: [mean, std, min, max]
    columns: [volume]

  - type: lags
    lags: [1, 2, 5, 10]
    columns: [close, volume]

  - type: higher_timeframe
    source_tf: 1h
    indicators: [SMA_20, RSI_14]
```

### 2. Feature Extractors
**Price features:**
- returns, log_returns
- high_low_ratio, close_open_ratio
- body_size, wick_sizes
- price_position (где close относительно high-low)

**Volume features:**
- volume_change
- volume_ma_ratio
- money_volume
- relative_volume

**Calendar features:**
- hour, day_of_week, month
- is_month_start, is_month_end
- trading_day_of_month
- time_since_open, time_to_close

**Ticker features:**
- ticker encoding (если несколько тикеров)
- sector, industry (если есть данные)

**Higher timeframe features:**
- Индикаторы с старших TF
- Align по timestamp

### 3. Feature Transformers
- Rolling statistics (mean, std, min, max, skew, kurt)
- Lags (shift)
- Differences (diff, pct_change)
- Ratios (feature1/feature2)

### 4. Feature Selection
**Filter methods:**
- Correlation filter
- Variance threshold
- Mutual information
- Chi-squared test

**Wrapper methods:**
- Forward selection
- Backward elimination
- Recursive Feature Elimination (RFE)

**Embedded methods:**
- Tree-based importance (RandomForest, LightGBM)
- L1 regularization (Lasso)
- SHAP values

**Drift detection:**
- PSI (Population Stability Index)
- KS test
- Adversarial validation

### 5. Feature Cache
```python
class FeatureCache:
    """Кэш вычисленных признаков"""

    def get(self, dataset_id: str, feature_config: dict) -> Optional[pd.DataFrame]:
        """Получить из кэша"""
        cache_key = self._compute_key(dataset_id, feature_config)
        # ...

    def save(self, dataset_id: str, feature_config: dict, features: pd.DataFrame):
        """Сохранить в кэш"""
        # ...
```

Структура:
```
artifacts/features/
├── {dataset_id}/
│   ├── {config_hash}.parquet
│   └── metadata.json
└── catalog.db  # SQLite каталог
```

### 6. Конфигурация
**configs/features/default.yaml** - базовые признаки
**configs/features/full.yaml** - все возможные признаки
**configs/features/minimal.yaml** - минимальный набор

## Критерии готовности

- [ ] FeatureGenerator работает с YAML конфигами
- [ ] Все extractors реализованы
- [ ] Rolling, lags, differences работают
- [ ] Feature selection методы работают
- [ ] Кэширование работает
- [ ] Higher timeframe features
- [ ] Версионирование признаков
- [ ] CLI: `generate-features`, `list-features`
- [ ] Производительность: 10K баров < 10 сек для всех признаков

## Промпты для реализации

### Промпт 1: FeatureGenerator и config parser
```
Реализуй:
1. src/features/config_parser.py - парсинг YAML в Feature объекты
2. src/features/generator.py - FeatureGenerator класс:
   - __init__(config: dict | Path)
   - generate(data: DataFrame) → DataFrame
   - Оркестрация всех extractors и transformers
   - Валидация конфигурации

Используй Pydantic для валидации конфигов.
```

### Промпт 2: Feature Extractors
```
Реализуй все extractors в src/features/extractors/:
- price.py: returns, ratios, body/wick sizes
- volume.py: volume-based features
- calendar.py: time-based features
- higher_tf.py: features from higher timeframes with alignment

Все должны быть каузальными и векторизованными.
```

### Промпт 3: Transformers и Selection
```
Реализуй:
1. src/features/transformers/ - rolling, lags, differences, ratios
2. src/features/selectors/ - все методы отбора признаков

Feature selection должен возвращать ranked list of features.
```

### Промпт 4: Cache и интеграция
```
Реализуй:
1. src/features/cache.py - FeatureCache с Parquet хранилищем
2. src/pipelines/feature_engineering.py - FeatureEngineeringPipeline
3. CLI команды в src/interfaces/cli/feature_commands.py

Кэш должен инвалидироваться при изменении конфига или данных.
```

## Важные замечания

- **Look-ahead bias**: Все признаки каузальные
- **Масштабирование**: Не делать на этом этапе (будет в пайплайне обучения)
- **Пропуски**: Документировать какие признаки генерируют NaN
- **Производительность**: Vectorize, используй numba для сложных

## Следующий этап
[Этап 05: Разметка таргетов](Этап_05_Разметка_таргетов.md)
