# Этап 12: Система пайплайнов

## Цель
Создать end-to-end пайплайны: от данных до бэктеста, с идемпотентностью и чекпоинтами.

## Зависимости
Этапы 00-11

## Пайплайны (docs/pipelines/)

1. **DataPreparationPipeline** - подготовка данных
2. **FeatureEngineeringPipeline** - генерация признаков
3. **NormalizationPipeline** - нормализация
4. **FeatureSelectionPipeline** - отбор признаков
5. **LabelingPipeline** - разметка
6. **TrainingPipeline** - обучение
7. **ValidationPipeline** - walk-forward, CV
8. **BacktestPipeline** - бэктест
9. **FullPipeline** - полный цикл

## Базовая структура

```python
class BasePipeline(ABC):
    """Базовый пайплайн"""

    def __init__(self, config: dict, checkpoint_dir: Path = None):
        self.config = config
        self.checkpoint_dir = checkpoint_dir
        self.state = {}

    @abstractmethod
    def run(self) -> PipelineResult:
        """Выполнить пайплайн"""

    def save_checkpoint(self, step: str, data: Any):
        """Сохранить чекпоинт"""

    def load_checkpoint(self, step: str) -> Any:
        """Загрузить чекпоинт"""

    def is_step_cached(self, step: str) -> bool:
        """Проверить наличие кэша"""
```

## FullPipeline
```python
class FullPipeline:
    """Полный цикл от сырых данных до бэктеста"""

    def __init__(self, config: dict):
        self.config = config
        self.pipelines = self._initialize_pipelines()

    def run(self) -> FullPipelineResult:
        """
        1. Data preparation
        2. Feature engineering
        3. Normalization
        4. Feature selection
        5. Labeling
        6. Training
        7. Validation
        8. Backtest
        9. Reporting
        """

        for pipeline in self.pipelines:
            if not self._should_skip(pipeline):
                result = pipeline.run()
                self._save_intermediate(result)
```

## Конфигурация

**configs/pipelines/full_pipeline.yaml:**
```yaml
name: full_training_backtest_pipeline
description: End-to-end pipeline

checkpoints:
  enabled: true
  dir: artifacts/checkpoints

data:
  source: local
  ticker: SBER
  timeframe: 5m
  from_date: 2020-01-01
  to_date: 2023-12-31

features:
  config_file: configs/features/default.yaml
  cache: true

labeling:
  method: triple_barrier
  config_file: configs/labeling/long_only.yaml

training:
  model_type: lightgbm
  config_file: configs/models/lightgbm_default.yaml
  hyperopt:
    enabled: false

backtest:
  commission: 0.001
  slippage: 0.0005
  exits:
    take_profit: 0.02
    stop_loss: 0.01
    time_stop: 20

reporting:
  output_dir: artifacts/reports
  formats: [html, pdf, json]
```

## Идемпотентность

- Кэширование результатов
- Проверка хэшей данных
- Skip если результат уже есть
- Автоматический перезапуск с последнего чекпоинта

## Критерии готовности

- [ ] Все пайплайны реализованы
- [ ] FullPipeline работает end-to-end
- [ ] Чекпоинты и кэширование
- [ ] Идемпотентность
- [ ] Логирование всех этапов
- [ ] CLI: `run-pipeline`, `resume-pipeline`
- [ ] Конфигурация через YAML

## Промпты

```
Реализуй src/pipelines/:
1. base.py - BasePipeline с чекпоинтами
2. full_pipeline.py - FullPipeline end-to-end
3. Обнови существующие пайплайны для поддержки checkpoints

FullPipeline должен:
- Запускать все этапы последовательно
- Передавать данные между этапами
- Сохранять чекпоинты
- Позволять resume с любого этапа
- Генерировать итоговый отчёт

CLI команды:
- run-pipeline - запустить
- resume-pipeline - возобновить
- pipeline-status - статус выполнения
```

## Следующий этап
[Этап 13: Оркестрация и управление экспериментами](Этап_13_Оркестрация.md)
