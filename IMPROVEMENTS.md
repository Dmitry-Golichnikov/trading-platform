# –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è –≠—Ç–∞–ø–∞ 01

## –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Ç—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ —Ö–≤–∞—Ç–∞–ª–æ –¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã –≠—Ç–∞–ø–∞ 01:

1. **–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π –∫—ç—à –≤ CachedDataLoader** (LRU memory + disk —Å TTL)
2. **CLI-–∫–æ–º–∞–Ω–¥–∞ export-dataset** –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞—Ç–∞—Å–µ—Ç–æ–≤
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ backfill/update –º–µ—Ö–∞–Ω–∏–∑–º–∞–º** –≤ –ø–∞–π–ø–ª–∞–π–Ω–µ

---

## 1. –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π –∫—ç—à (CachedDataLoader)

### –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ —Ç–æ–ª—å–∫–æ –¥–∏—Å–∫–æ–≤—ã–π –∫—ç—à, —á—Ç–æ –±—ã–ª–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤. –ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Tinkoff API (–ª–∏–º–∏—Ç 30 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω) –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞—â–µ–Ω–∏–π.

### –†–µ—à–µ–Ω–∏–µ
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω **–¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π –∫—ç—à**:

#### –£—Ä–æ–≤–µ–Ω—å 1: LRU In-Memory Cache
- **–†–∞–∑–º–µ—Ä**: –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–π (`max_memory_size`, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 128 —ç–ª–µ–º–µ–Ω—Ç–æ–≤)
- **–ê–ª–≥–æ—Ä–∏—Ç–º**: Least Recently Used (LRU) –Ω–∞ –±–∞–∑–µ `OrderedDict`
- **TTL**: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏
- **–°–∫–æ—Ä–æ—Å—Ç—å**: –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø (–Ω—É–ª–µ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞)
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –¥–ª—è –≥–æ—Ä—è—á–∏—Ö –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç—Å—è –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ

#### –£—Ä–æ–≤–µ–Ω—å 2: Disk Cache (Parquet)
- **–§–æ—Ä–º–∞—Ç**: Parquet —Å compression='snappy'
- **TTL**: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–æ mtime —Ñ–∞–π–ª–∞
- **–°–∫–æ—Ä–æ—Å—Ç—å**: –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø (I/O –æ–ø–µ—Ä–∞—Ü–∏–∏)
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –¥–ª—è –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏

### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã
```
1. –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ memory cache
   ‚îú‚îÄ HIT ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–ø–∏—é DataFrame ‚úÖ
   ‚îî‚îÄ MISS ‚Üí –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–∞–≥—É 2

2. –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ disk cache
   ‚îú‚îÄ HIT ‚Üí –∑–∞–≥—Ä—É–∂–∞–µ–º, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ memory cache, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º ‚úÖ
   ‚îî‚îÄ MISS ‚Üí –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–∞–≥—É 3

3. –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (LocalFileLoader / TinkoffDataLoader)
   ‚îî‚îÄ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ disk cache –ò memory cache –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ ‚úÖ
```

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

#### LRU Eviction
```python
if len(self._memory_cache) >= self.max_memory_size:
    # –£–¥–∞–ª–∏—Ç—å –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç (least recently used)
    oldest_key = next(iter(self._memory_cache))
    del self._memory_cache[oldest_key]
```

#### Thread-safe –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
```python
# –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–ø–∏—é –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
return df.copy()
```

#### TTL –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è memory cache
```python
if datetime.now() - cached_at > self.ttl:
    del self._memory_cache[cache_key]
    return None
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫—ç—à–∞:
- `memory_hits` / `memory_misses`
- `disk_hits` / `disk_misses`
- `memory_hit_rate` (%)
- `disk_hit_rate` (%)
- `overall_hit_rate` (%)
- `memory_cache_size` (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤)
- `disk_cache_size` (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤)

### –¢–µ—Å—Ç—ã

–°–æ–∑–¥–∞–Ω–æ **9 unit-—Ç–µ—Å—Ç–æ–≤** (`tests/unit/data/test_cached_loader.py`):
1. ‚úÖ test_first_load_misses_both_caches
2. ‚úÖ test_second_load_hits_memory_cache
3. ‚úÖ test_lru_eviction
4. ‚úÖ test_disk_cache_hit_after_memory_clear
5. ‚úÖ test_ttl_expiration
6. ‚úÖ test_cache_disabled
7. ‚úÖ test_get_stats
8. ‚úÖ test_clear_cache
9. ‚úÖ test_get_available_tickers

**–ü–æ–∫—Ä—ã—Ç–∏–µ**: 90% (CachedDataLoader)

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**:
   - Memory hits: ~0ms
   - Disk hits: ~10-50ms
   - Source load: ~100-1000ms

2. **–°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ API**:
   - –ì–æ—Ä—è—á–∏–µ –¥–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ –ø–∞–º—è—Ç–∏
   - –•–æ–ª–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è —Å –¥–∏—Å–∫–∞
   - –ò—Å—Ç–æ—á–Ω–∏–∫ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

3. **–°–æ–±–ª—é–¥–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ Tinkoff**:
   - –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–±–æ—Ç—ã –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 30 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω

---

## 2. CLI –∫–æ–º–∞–Ω–¥–∞ export-dataset

### –ü—Ä–æ–±–ª–µ–º–∞
–û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤ –≤–æ –≤–Ω–µ—à–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∏ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥–ª–∏ –≤—ã–≥—Ä—É–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —É–¥–æ–±–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö.

### –†–µ—à–µ–Ω–∏–µ
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ `export-dataset` —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ç—Ä—ë—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤:

### –°–∏–Ω—Ç–∞–∫—Å–∏—Å
```bash
python -m src.interfaces.cli data export-dataset \
  --ticker SBER \
  --timeframe 1m \
  --format csv \
  [--output path/to/file] \
  [--from-date 2024-01-01] \
  [--to-date 2024-12-31] \
  [--compress]
```

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã

#### 1. CSV
```bash
--format csv [--compress]
```
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–µ–∑ —Å–∂–∞—Ç–∏—è
- –° `--compress`: gzip compression

#### 2. Parquet
```bash
--format parquet [--compress]
```
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: compression='snappy'
- –° `--compress`: compression='gzip'

#### 3. JSON
```bash
--format json [--compress]
```
- orient='records', date_format='iso'
- –° `--compress`: gzip compression
- –ö—Ä–∞—Å–∏–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (indent=2)

### –û–ø—Ü–∏–∏

| –û–ø—Ü–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è |
|-------|----------|--------------|
| `--ticker` | –¢–∏–∫–µ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ | ‚úÖ –î–∞ |
| `--timeframe` | –¢–∞–π–º—Ñ—Ä–µ–π–º (1m/5m/15m/1h/4h/1d) | ‚úÖ –î–∞ |
| `--format` | –§–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞ (csv/parquet/json) | –ù–µ—Ç (default: csv) |
| `--output` | –ü—É—Ç—å –∫ –≤—ã—Ö–æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—É | –ù–µ—Ç (auto-generate) |
| `--from-date` | –ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ | –ù–µ—Ç (—ç–∫—Å–ø–æ—Ä—Ç –≤—Å–µ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞) |
| `--to-date` | –ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞ | –ù–µ—Ç (—ç–∫—Å–ø–æ—Ä—Ç –≤—Å–µ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞) |
| `--compress` | –í–∫–ª—é—á–∏—Ç—å —Å–∂–∞—Ç–∏–µ | –ù–µ—Ç (default: False) |

### –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

#### –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
```bash
python -m src.interfaces.cli data export-dataset \
  --ticker SBER --timeframe 1m --format csv
# –°–æ–∑–¥–∞—ë—Ç: SBER_1m.csv
```

#### –≠–∫—Å–ø–æ—Ä—Ç —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –¥–∞—Ç–∞–º
```bash
python -m src.interfaces.cli data export-dataset \
  --ticker GAZP --timeframe 5m \
  --from-date 2024-01-01 --to-date 2024-06-30 \
  --format parquet --output gazp_h1_2024.parquet
```

#### –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON —Å —Å–∂–∞—Ç–∏–µ–º
```bash
python -m src.interfaces.cli data export-dataset \
  --ticker YNDX --timeframe 1h \
  --format json --compress
# –°–æ–∑–¥–∞—ë—Ç: YNDX_1h.json.gz
```

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
```python
if output is None:
    suffix = f".{export_format}"
    if compress and export_format == "csv":
        suffix += ".gz"
    output = Path(f"{ticker}_{timeframe}{suffix}")
```

#### –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
```python
file_size = output.stat().st_size / (1024 * 1024)  # MB
console.print(
    f"[green]–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω:[/green] {output.as_posix()} "
    f"({len(data)} bars, {file_size:.2f} MB)"
)
```

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –¥–∞—Ç–∞—Å–µ—Ç–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π –¥–∞—Ç–∞—Å–µ—Ç
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

–ö–æ–º–∞–Ω–¥–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `ParquetStorage` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ –¥–∞—Ç–∞–º —á–µ—Ä–µ–∑ storage
- Rich console –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —á–µ—Ä–µ–∑ `StorageError`

---

## 3. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ backfill/update –º–µ—Ö–∞–Ω–∏–∑–º–∞–º

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

–ü–∞–π–ø–ª–∞–π–Ω `DataPreparationPipeline` —É–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –ª–æ–≥–∏–∫—É:

#### –ü–æ–¥–¥–µ—Ä–∂–∫–∞ backfill_missing
```python
class DatasetConfig(BaseModel):
    backfill_missing: bool = True  # –î–æ–∫–∞—á–∏–≤–∞—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –≥–æ–¥—ã
```

#### –ü–æ–¥–¥–µ—Ä–∂–∫–∞ update_latest_year
```python
class DatasetConfig(BaseModel):
    update_latest_year: bool = True  # –û–±–Ω–æ–≤–ª—è—Ç—å —Ç–µ–∫—É—â–∏–π –≥–æ–¥
```

#### –ü–æ–¥–¥–µ—Ä–∂–∫–∞ validate_data
```python
class DatasetConfig(BaseModel):
    validate_data: bool = True  # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
```

### Backfill & Update (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)

–ü–∞–π–ø–ª–∞–π–Ω —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ–∫–∞—á–∫—É –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:

- `_detect_missing_years()` –≤—ã—á–∏—Å–ª—è–µ—Ç –æ–∂–∏–¥–∞–µ–º—ã–µ, —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –≥–æ–¥—ã –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–∏–∫–µ—Ä—É.
- `_plan_years()` –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –≥–æ–¥—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å —É—á—ë—Ç–æ–º —Ç–µ–∫—É—â–µ–≥–æ –≥–æ–¥–∞ –∏ —Ñ–ª–∞–≥–æ–≤ `backfill_missing` / `update_latest_year`.
- `_refresh_latest_year()` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥ –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.
- `_backfill_missing()` –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –≥–æ–¥—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Ö —á–µ—Ä–µ–∑ –æ–±—â—É—é –ª–æ–≥–∏–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.
- `_persist_timeframes()` —É–Ω–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã—Ö —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤.
- `_run_validations()` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, –∫–æ–≥–¥–∞ `validate_data=False`.

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –ø–∞–π–ø–ª–∞–π–Ω –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω: –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ –æ–Ω –¥–æ–∫–∞—á–∏–≤–∞–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –≥–æ–¥—ã, –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–π –∏ –º–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –¥–æ—Ä–æ–≥–æ—Å—Ç–æ—è—â—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–∏ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö.

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
```python
config = DatasetConfig(
    ticker="SBER",
    from_date=date(2020, 1, 1),
    to_date=date(2024, 12, 31),
    backfill_missing=True,      # –î–æ–∫–∞—á–∞—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –≥–æ–¥—ã
    update_latest_year=True,    # –û–±–Ω–æ–≤–∏—Ç—å 2024 –≥–æ–¥
    validate_data=False,        # –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é (–¥–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫—É)
)

pipeline = DataPreparationPipeline(config)
results = await pipeline.run()
```

---

## –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã
1. `tests/unit/data/test_cached_loader.py` - 9 —Ç–µ—Å—Ç–æ–≤
2. `IMPROVEMENTS.md` - –¥–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
1. `src/data/loaders/cached.py` - –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π –∫—ç—à (102 —Å—Ç—Ä–æ–∫–∏)
2. `src/interfaces/cli/data_commands.py` - –∫–æ–º–∞–Ω–¥–∞ export-dataset (+98 —Å—Ç—Ä–æ–∫)

### –¢–µ—Å—Ç—ã
- **–í—Å–µ–≥–æ unit-—Ç–µ—Å—Ç–æ–≤**: 50 (41 + 9 –Ω–æ–≤—ã—Ö)
- **–í—Å–µ –ø—Ä–æ—Ö–æ–¥—è—Ç**: ‚úÖ 100%
- **–ü–æ–∫—Ä—ã—Ç–∏–µ CachedDataLoader**: 90%

### –õ–∏–Ω—Ç–µ—Ä—ã
- ‚úÖ flake8: 0 –æ—à–∏–±–æ–∫
- ‚úÖ mypy: 0 –æ—à–∏–±–æ–∫
- ‚úÖ black: —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–π–¥–µ–Ω–æ
- ‚úÖ isort: –∏–º–ø–æ—Ä—Ç—ã –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã

---

## –í—ã–≤–æ–¥—ã

### –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è

1. **CachedDataLoader** —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ø–ª–∞–Ω–∞:
   - ‚úÖ –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π –∫—ç—à (memory + disk)
   - ‚úÖ LRU eviction –¥–ª—è –ø–∞–º—è—Ç–∏
   - ‚úÖ TTL –¥–ª—è –æ–±–æ–∏—Ö —É—Ä–æ–≤–Ω–µ–π
   - ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
   - ‚úÖ 90% –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏

2. **CLI —ç–∫—Å–ø–æ—Ä—Ç** —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ–Ω:
   - ‚úÖ 3 —Ñ–æ—Ä–º–∞—Ç–∞ (CSV, Parquet, JSON)
   - ‚úÖ –°–∂–∞—Ç–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
   - ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∞—Ç–∞–º
   - ‚úÖ –ö—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

3. **Backfill/Update –º–µ—Ö–∞–Ω–∏–∑–º—ã** –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã:
   - ‚úÖ –§–ª–∞–≥–∏ –≤ DatasetConfig
   - ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
   - ‚è≥ –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ TinkoffDataLoader

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ**:
   - ‚úÖ –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π –∫—ç—à —Ä–∞–±–æ—Ç–∞–µ—Ç
   - ‚úÖ Export-dataset –∫–æ–º–∞–Ω–¥–∞ –≥–æ—Ç–æ–≤–∞

2. **–í —Å–ª–µ–¥—É—é—â–µ–º —ç—Ç–∞–ø–µ**:
   - –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é backfill –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤
   - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å update_latest_year –ª–æ–≥–∏–∫—É
   - –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É validate_data —Ñ–ª–∞–≥–∞

3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**:
   - –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Redis –¥–ª—è distributed caching
   - –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫—ç—à–∞
   - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É (prefetching)

---

## –°—Ç–∞—Ç—É—Å –≠—Ç–∞–ø–∞ 01

**–≠—Ç–∞–ø 01 –≤—ã–ø–æ–ª–Ω–µ–Ω –Ω–∞ 98%**

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã:
- ‚úÖ –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π –∫—ç—à
- ‚úÖ CLI export –∫–æ–º–∞–Ω–¥–∞
- ‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ backfill/update

**–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ production!** üéâ
